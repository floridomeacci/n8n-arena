<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>N8N Arena</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #ffffff;
      --bg-warm: #f7f7f7;
      --surface: #ffffff;
      --border: #ebebeb;
      --border-hover: #dddddd;
      --text: #222222;
      --text-secondary: #717171;
      --text-light: #b0b0b0;
      --primary: #FF385C;
      --primary-light: #fff0f3;
      --primary-dark: #d93b5c;
      --green: #008A05;
      --green-bg: #f0faf0;
      --green-border: #c6ecc6;
      --orange: #c77800;
      --orange-bg: #fff8ee;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 6px 20px rgba(0,0,0,0.1);
      --shadow-xl: 0 12px 40px rgba(0,0,0,0.12);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-warm);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: flex;
      height: 100vh;
    }

    /* â”€â”€â”€ Left Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .left-panel {
      width: 380px;
      min-width: 340px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .left-panel::-webkit-scrollbar { width: 0; }

    .logo-area {
      padding: 28px 24px 24px;
      border-bottom: 1px solid var(--border);
    }

    .logo-area h1 {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-area h1 span.logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      font-size: 16px;
    }

    .logo-area .subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 400;
      margin-top: 4px;
      margin-left: 42px;
    }

    /* â”€â”€â”€ Task list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-list {
      padding: 16px;
      flex: 1;
    }

    .task-list-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 8px 12px;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 2px;
      border: 2px solid transparent;
    }

    .task-item:hover {
      background: var(--bg-warm);
    }

    .task-item.active {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .task-item.completed-task {
      opacity: 0.45;
    }

    .task-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 700;
      flex-shrink: 0;
      background: var(--bg-warm);
      color: var(--text-secondary);
      transition: all 0.2s;
    }

    .task-item.active .task-number {
      background: var(--primary);
      color: white;
    }

    .task-item.completed-task .task-number {
      background: var(--green);
      color: white;
    }

    .task-info h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .task-info .task-sub {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 1px;
      font-weight: 400;
    }

    /* â”€â”€â”€ Active task detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .active-task-detail {
      padding: 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }

    .active-task-detail .task-icon {
      font-size: 36px;
      margin-bottom: 16px;
    }

    .task-round-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 600;
      color: var(--primary);
      background: var(--primary-light);
      padding: 4px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .active-task-detail h2 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.3px;
      margin-bottom: 8px;
    }

    .active-task-detail .desc {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .active-task-detail .desc strong {
      color: var(--text);
      font-weight: 600;
    }

    .active-task-detail .desc code {
      background: var(--bg-warm);
      padding: 2px 7px;
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--primary);
      border: 1px solid var(--border);
    }

    .completion-stat {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 16px;
      padding: 12px 14px;
      background: var(--bg-warm);
      border-radius: var(--radius);
    }

    .completion-stat .stat-bar {
      flex: 1;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .completion-stat .stat-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .completion-stat .stat-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
      font-family: 'JetBrains Mono', monospace;
    }

    /* â”€â”€â”€ CURL blocks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .curl-block {
      background: #1a1a2e;
      border-radius: var(--radius);
      margin-top: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }

    .curl-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 14px;
      background: #222240;
    }

    .curl-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #8888a8;
      font-family: 'JetBrains Mono', monospace;
    }

    .curl-copy {
      background: none;
      border: 1px solid rgba(255,255,255,0.12);
      color: #aaa;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      transition: all 0.15s;
    }

    .curl-copy:hover {
      border-color: rgba(255,255,255,0.3);
      color: white;
    }

    .curl-copy.copied {
      border-color: var(--green);
      color: var(--green);
    }

    .curl-code {
      padding: 14px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.8;
      color: #e4e4ef;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .curl-code .curl-flag { color: #ff9100; }
    .curl-code .curl-str { color: #a78bfa; }

    .curl-step-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--orange);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 14px;
      margin-bottom: 4px;
    }

    /* â”€â”€â”€ Admin controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .admin-section {
      padding: 16px 24px 20px;
      border-top: 1px solid var(--border);
    }

    .admin-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .admin-rounds {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .admin-btn {
      flex: 1;
      padding: 10px 8px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: 'Inter', sans-serif;
    }

    .admin-btn:hover {
      border-color: var(--text-secondary);
      color: var(--text);
      box-shadow: var(--shadow-sm);
    }

    .admin-btn.active-round {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(255, 56, 92, 0.3);
    }

    .admin-actions {
      display: flex;
      gap: 8px;
    }

    .admin-btn.add-player {
      background: var(--text);
      color: var(--surface);
      border-color: var(--text);
    }

    .admin-btn.add-player:hover {
      opacity: 0.85;
    }

    .admin-btn.danger {
      color: var(--primary);
      border-color: var(--border);
    }

    .admin-btn.danger:hover {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    .server-url {
      padding: 12px 24px 16px;
      border-top: 1px solid var(--border);
    }

    .server-url code {
      display: block;
      background: var(--bg-warm);
      padding: 10px 12px;
      border-radius: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
      word-break: break-all;
    }

    /* â”€â”€â”€ Right Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .right-panel {
      flex: 1;
      padding: 28px 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: var(--bg-warm);
    }

    .right-panel::-webkit-scrollbar { width: 6px; }
    .right-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .grid-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .grid-header h2 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--text);
    }

    .player-count {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
      flex: 1;
      align-content: start;
    }

    /* â”€â”€â”€ Player Cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px 20px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 155px;
      box-shadow: var(--shadow-sm);
    }

    .cell:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .cell.completed {
      background: var(--green-bg);
      border-color: var(--green-border);
      box-shadow: 0 4px 16px rgba(0, 138, 5, 0.1);
    }

    .cell.in-progress {
      background: var(--orange-bg);
      border-color: #f0d9a8;
    }

    .cell-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      background: var(--bg-warm);
      color: var(--text);
      text-transform: uppercase;
      transition: all 0.3s;
    }

    .cell.completed .cell-avatar {
      background: var(--green);
      color: white;
      animation: pop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cell.in-progress .cell-avatar {
      background: var(--orange);
      color: white;
    }

    .cell-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      color: var(--text);
    }

    .cell-status {
      font-size: 13px;
      font-weight: 400;
      color: var(--text-secondary);
    }

    .cell.completed .cell-status {
      color: var(--green);
      font-weight: 600;
    }

    .cell-checkmark {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--green);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 900;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cell.completed .cell-checkmark {
      opacity: 1;
      transform: scale(1);
    }

    .cell-remove {
      position: absolute;
      top: 8px;
      left: 10px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-light);
      font-size: 14px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cell:hover .cell-remove { opacity: 0.6; }

    .cell-remove:hover {
      opacity: 1 !important;
      background: var(--primary-light);
      color: var(--primary);
    }

    /* Progress bar (task 4) */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--green));
      border-radius: 2px;
      transition: width 0.3s;
    }

    /* Task dots */
    .task-progress {
      display: flex;
      gap: 4px;
      margin-top: 10px;
    }

    .task-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.25s;
    }

    .task-dot.done {
      background: var(--green);
    }

    .task-dot.current {
      background: var(--primary);
    }

    /* â”€â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      gap: 16px;
      padding: 40px;
    }

    .empty-state .icon {
      font-size: 56px;
      opacity: 0.25;
    }

    .empty-state p {
      font-size: 16px;
      font-weight: 500;
    }

    .empty-state code {
      background: var(--surface);
      padding: 12px 18px;
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 400px;
      box-shadow: var(--shadow-xl);
      transform: scale(0.95) translateY(10px);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.show .modal {
      transform: scale(1) translateY(0);
    }

    .modal h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .modal input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      outline: none;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .modal input:focus {
      border-color: var(--text);
      box-shadow: 0 0 0 1px var(--text);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 22px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }

    .modal-btn.cancel {
      background: transparent;
      color: var(--text-secondary);
    }

    .modal-btn.cancel:hover {
      background: var(--bg-warm);
    }

    .modal-btn.confirm {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .modal-btn.confirm:hover {
      background: var(--primary-dark);
    }

    .modal-result {
      margin-top: 16px;
      padding: 12px 14px;
      background: var(--green-bg);
      border: 1px solid var(--green-border);
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--green);
      display: none;
      word-break: break-all;
    }

    /* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cell { animation: slideUp 0.35s ease; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <div class="logo-area">
        <h1><span class="logo-icon">âš¡</span> N8N Arena</h1>
        <div class="subtitle">Interactive API Challenge</div>
      </div>

      <div class="task-list" id="taskList"></div>

      <div class="active-task-detail" id="activeTaskDetail"></div>

      <div class="admin-section">
        <div class="admin-label">Rounds</div>
        <div class="admin-rounds">
          <button class="admin-btn" onclick="setTask(1)">1</button>
          <button class="admin-btn" onclick="setTask(2)">2</button>
          <button class="admin-btn" onclick="setTask(3)">3</button>
          <button class="admin-btn" onclick="setTask(4)">4</button>
          <button class="admin-btn" onclick="setTask(5)">5</button>
          <button class="admin-btn" onclick="setTask(6)">6</button>
        </div>
        <div class="admin-actions">
          <button class="admin-btn add-player" onclick="showAddPlayer()" style="flex:2">+ Add Player</button>
          <button class="admin-btn danger" onclick="resetAll()">Reset</button>
        </div>
      </div>

      <div class="server-url">
        <code id="serverUrl"></code>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <div class="grid-header">
        <h2>Participants</h2>
        <span class="player-count" id="playerCount">0 players</span>
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Add Player Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h3>Add a new player</h3>
      <input type="text" id="playerNameInput" placeholder="Enter player name..." autocomplete="off" />
      <div class="modal-result" id="modalResult"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideModal()">Cancel</button>
        <button class="modal-btn confirm" onclick="registerPlayer()">Register</button>
      </div>
    </div>
  </div>

  <script>
    const BASE = window.location.origin;
    let state = { currentTask: 1, participants: [], taskDescriptions: [] };
    let previousCompleted = {};

    document.getElementById('serverUrl').textContent = BASE;

    // â”€â”€â”€ Real-time: SSE with polling fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let useSSE = true;
    let pollTimer = null;

    function processState(newState) {
      state = newState;
      render();
      newState.participants.forEach((p) => {
        const prev = previousCompleted[p.id] || [];
        const newTasks = p.completedTasks.filter((t) => !prev.includes(t));
        if (newTasks.includes(newState.currentTask)) {
          celebratePlayer(p.id);
        }
        previousCompleted[p.id] = [...p.completedTasks];
      });
    }

    function connectSSE() {
      const es = new EventSource(`${BASE}/api/events`);
      es.onmessage = (e) => processState(JSON.parse(e.data));
      es.onerror = () => {
        es.close();
        useSSE = false;
        startPolling();
      };
    }

    async function poll() {
      try {
        const res = await fetch(`${BASE}/api/state`);
        const data = await res.json();
        processState(data);
      } catch (e) { /* retry next tick */ }
    }

    function startPolling() {
      if (pollTimer) return;
      poll();
      pollTimer = setInterval(poll, 1000);
    }

    connectSSE();

    // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      renderTaskList();
      renderActiveTask();
      renderGrid();
      renderRoundButtons();
    }

    function renderTaskList() {
      const el = document.getElementById('taskList');
      el.innerHTML = '<div class="task-list-label">Challenges</div>' + state.taskDescriptions
        .map((t) => {
          const isActive = t.id === state.currentTask;
          const allDone = state.participants.length > 0 && state.participants.every(
            (p) => p.completedTasks.includes(t.id)
          );
          let cls = 'task-item';
          if (isActive) cls += ' active';
          if (t.id < state.currentTask && allDone) cls += ' completed-task';

          return `
            <div class="${cls}" onclick="setTask(${t.id})">
              <div class="task-number">${t.id}</div>
              <div class="task-info">
                <h3>${t.title}</h3>
                <div class="task-sub">${t.subtitle}</div>
              </div>
            </div>
          `;
        })
        .join('');
    }

    function getCurlCommands(taskId) {
      const url = BASE;
      const id = '{your-id}';
      switch (taskId) {
        case 1:
          return [{
            label: null,
            cmd: `curl ${url}/api/player/${id}/task1`,
            raw: `curl ${url}/api/player/${id}/task1`
          }];
        case 2:
          return [{
            label: null,
            cmd: `curl <span class="curl-flag">-u</span> <span class="curl-str">n8n:rocks</span> ${url}/api/player/${id}/task2`,
            raw: `curl -u n8n:rocks ${url}/api/player/${id}/task2`
          }];
        case 3:
          return [{
            label: null,
            cmd: `curl <span class="curl-flag">-u</span> <span class="curl-str">n8n:rocks</span> <span class="curl-flag">-X POST</span> \\\n  <span class="curl-flag">-H</span> <span class="curl-str">"Content-Type: application/json"</span> \\\n  <span class="curl-flag">-d</span> <span class="curl-str">'{"message": "Hello from N8N!"}'</span> \\\n  ${url}/api/player/${id}/task3`,
            raw: `curl -u n8n:rocks -X POST -H "Content-Type: application/json" -d '{"message": "Hello from N8N!"}' ${url}/api/player/${id}/task3`
          }];
        case 4:
          return [{
            label: 'Run this 4 times!',
            cmd: `curl <span class="curl-flag">-X POST</span> ${url}/api/player/${id}/task4`,
            raw: `curl -X POST ${url}/api/player/${id}/task4`
          }];
        case 5:
          return [
            {
              label: 'Step 1 â€” Get the key',
              cmd: `curl ${url}/api/player/${id}/task5/key`,
              raw: `curl ${url}/api/player/${id}/task5/key`
            },
            {
              label: 'Step 2 â€” Post it back',
              cmd: `curl <span class="curl-flag">-X POST</span> \\\n  <span class="curl-flag">-H</span> <span class="curl-str">"Content-Type: application/json"</span> \\\n  <span class="curl-flag">-d</span> <span class="curl-str">'{"key": "PASTE_KEY_HERE"}'</span> \\\n  ${url}/api/player/${id}/task5`,
              raw: `curl -X POST -H "Content-Type: application/json" -d '{"key": "PASTE_KEY_HERE"}' ${url}/api/player/${id}/task5`
            }
          ];
        case 6:
          return [{
            label: null,
            cmd: `curl <span class="curl-flag">-X POST</span> \\\n  <span class="curl-flag">-H</span> <span class="curl-str">"Content-Type: application/json"</span> \\\n  <span class="curl-flag">-d</span> <span class="curl-str">'{"image": "data:image/png;base64,iVBOR..."}'</span> \\\n  ${url}/api/player/${id}/task6`,
            raw: `curl -X POST -H "Content-Type: application/json" -d '{"image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="}' ${url}/api/player/${id}/task6`
          }];
        default:
          return [];
      }
    }

    function copyCurl(btn, text) {
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'âœ“ Copied';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 1500);
      });
    }

    function renderActiveTask() {
      const el = document.getElementById('activeTaskDetail');
      const task = state.taskDescriptions.find((t) => t.id === state.currentTask);
      if (!task) return;

      const completed = state.participants.filter((p) =>
        p.completedTasks.includes(state.currentTask)
      ).length;
      const total = state.participants.length;
      const pct = total ? Math.round((completed / total) * 100) : 0;

      const curls = getCurlCommands(task.id);
      const curlHtml = curls.map((c) => `
        ${c.label ? `<div class="curl-step-label">${c.label}</div>` : ''}
        <div class="curl-block">
          <div class="curl-header">
            <span class="curl-label">curl</span>
            <button class="curl-copy" onclick="copyCurl(this, ${JSON.stringify(c.raw).replace(/"/g, '&quot;')})">Copy</button>
          </div>
          <div class="curl-code">${c.cmd}</div>
        </div>
      `).join('');

      el.innerHTML = `
        <div class="task-icon">${task.icon}</div>
        <div class="task-round-badge">Round ${task.id}</div>
        <h2>${task.title}</h2>
        <div class="desc">${task.description}</div>
        ${curlHtml}
        <div class="completion-stat">
          <div class="stat-bar"><div class="stat-fill" style="width: ${pct}%"></div></div>
          <span class="stat-text">${completed}/${total}</span>
        </div>
      `;
    }

    function renderGrid() {
      const grid = document.getElementById('grid');
      const count = document.getElementById('playerCount');
      count.textContent = `${state.participants.length} player${state.participants.length !== 1 ? 's' : ''}`;

      if (state.participants.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="icon">ðŸ‘¥</div>
            <p>No players registered yet</p>
            <code>POST ${BASE}/api/register { "name": "..." }</code>
          </div>
        `;
        return;
      }

      grid.innerHTML = state.participants
        .map((p) => {
          const done = p.completedTasks.includes(state.currentTask);
          const inProgress = state.currentTask === 4 && p.postCount > 0 && !done;
          let cls = 'cell';
          if (done) cls += ' completed';
          else if (inProgress) cls += ' in-progress';

          const initials = p.name
            .split(' ')
            .map((w) => w[0])
            .join('')
            .slice(0, 2);

          let statusText = 'Waiting...';
          if (done) statusText = 'âœ“ Completed';
          if (state.currentTask === 4 && !done) statusText = `${p.postCount}/4 requests`;

          const progressBar =
            state.currentTask === 4 && !done
              ? `<div class="progress-bar"><div class="progress-fill" style="width: ${(p.postCount / 4) * 100}%"></div></div>`
              : '';

          const dots = state.taskDescriptions
            .map(
              (t) =>
                `<div class="task-dot ${p.completedTasks.includes(t.id) ? 'done' : ''} ${t.id === state.currentTask ? 'current' : ''}"></div>`
            )
            .join('');

          return `
            <div class="cell ${cls}" id="cell-${p.id}">
              <button class="cell-remove" onclick="removePlayer('${p.id}')" title="Remove">Ã—</button>
              <div class="cell-checkmark">âœ“</div>
              <div class="cell-avatar">${initials}</div>
              <div class="cell-name" title="${p.name}">${p.name}</div>
              <div class="cell-status">${statusText}</div>
              ${progressBar}
              <div class="task-progress">${dots}</div>
            </div>
          `;
        })
        .join('');
    }

    function renderRoundButtons() {
      document.querySelectorAll('.admin-rounds .admin-btn').forEach((btn) => {
        const round = parseInt(btn.textContent);
        if (!isNaN(round)) {
          btn.classList.toggle('active-round', round === state.currentTask);
        }
      });
    }

    // â”€â”€â”€ Admin Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function setTask(task) {
      await fetch(`${BASE}/api/admin/task`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ task }),
      });
    }

    async function resetAll() {
      if (!confirm('Reset all progress?')) return;
      await fetch(`${BASE}/api/admin/reset`, { method: 'POST' });
    }

    async function removePlayer(id) {
      if (!confirm('Remove this player?')) return;
      await fetch(`${BASE}/api/admin/player/${id}`, { method: 'DELETE' });
    }

    // â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAddPlayer() {
      document.getElementById('modal').classList.add('show');
      document.getElementById('playerNameInput').value = '';
      document.getElementById('modalResult').style.display = 'none';
      setTimeout(() => document.getElementById('playerNameInput').focus(), 100);
    }

    function hideModal() {
      document.getElementById('modal').classList.remove('show');
    }

    async function registerPlayer() {
      const name = document.getElementById('playerNameInput').value.trim();
      if (!name) return;

      const res = await fetch(`${BASE}/api/register`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name }),
      });
      const data = await res.json();

      const result = document.getElementById('modalResult');
      result.style.display = 'block';
      result.textContent = `âœ“ Registered! ID: ${data.id}`;

      document.getElementById('playerNameInput').value = '';
      document.getElementById('playerNameInput').focus();
    }

    document.getElementById('playerNameInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') registerPlayer();
      if (e.key === 'Escape') hideModal();
    });

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) hideModal();
    });

    // â”€â”€â”€ Celebration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function celebratePlayer(id) {
      const cell = document.getElementById(`cell-${id}`);
      if (!cell) return;

      for (let i = 0; i < 16; i++) {
        const particle = document.createElement('div');
        const colors = ['#FF385C', '#008A05', '#c77800', '#6c5ce7', '#00b0ff', '#ffea00'];
        const size = 4 + Math.random() * 5;
        particle.style.cssText = `
          position: fixed;
          width: ${size}px;
          height: ${size}px;
          border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
          background: ${colors[Math.floor(Math.random() * colors.length)]};
          pointer-events: none;
          z-index: 999;
        `;

        const rect = cell.getBoundingClientRect();
        const cx = rect.left + rect.width / 2;
        const cy = rect.top + rect.height / 2;
        particle.style.left = cx + 'px';
        particle.style.top = cy + 'px';

        document.body.appendChild(particle);

        const angle = (Math.PI * 2 * i) / 16;
        const distance = 50 + Math.random() * 70;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance - 20;

        particle.animate(
          [
            { transform: 'translate(0, 0) scale(1)', opacity: 1 },
            { transform: `translate(${dx}px, ${dy}px) scale(0)`, opacity: 0 },
          ],
          { duration: 700, easing: 'cubic-bezier(0.4, 0, 0.2, 1)' }
        ).onfinish = () => particle.remove();
      }
    }
  </script>
</body>
</html>
