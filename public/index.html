<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>N8N Arena</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #ffffff;
      --bg-warm: #f7f7f7;
      --surface: #ffffff;
      --border: #ebebeb;
      --text: #222222;
      --text-secondary: #717171;
      --text-light: #b0b0b0;
      --primary: #FF385C;
      --primary-light: #fff0f3;
      --primary-dark: #d93b5c;
      --green: #008A05;
      --green-bg: #f0faf0;
      --green-border: #c6ecc6;
      --orange: #c77800;
      --orange-bg: #fff8ee;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 6px 20px rgba(0,0,0,0.1);
      --shadow-xl: 0 12px 40px rgba(0,0,0,0.12);
      --radius: 12px;
      --radius-lg: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-warm);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ Full-screen layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€â”€ Top bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text);
    }

    .logo-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--primary);
      color: white;
      border-radius: 8px;
      font-size: 16px;
    }

    .divider {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    .task-badge {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .task-badge .round-pill {
      font-size: 11px;
      font-weight: 600;
      color: var(--primary);
      background: var(--primary-light);
      padding: 5px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .task-badge .task-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
    }

    .task-badge .task-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-left: 8px;
      font-weight: 400;
    }

    .top-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stat-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: var(--bg-warm);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .stat-chip .stat-num {
      font-weight: 700;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-chip .stat-bar-mini {
      width: 40px;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }

    .stat-chip .stat-bar-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
      transition: width 0.4s ease;
    }

    .top-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }

    .top-btn:hover {
      border-color: var(--text-secondary);
      color: var(--text);
    }

    .top-btn.add {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }

    .top-btn.add:hover { opacity: 0.85; }

    .top-btn.danger { color: var(--primary); }
    .top-btn.danger:hover {
      background: var(--primary-light);
      border-color: var(--primary);
    }

    /* â”€â”€â”€ CURL drawer (collapsible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .curl-drawer {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease;
    }

    .curl-drawer.open {
      max-height: 400px;
    }

    .curl-inner {
      padding: 16px 32px 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .curl-block {
      background: #1a1a2e;
      border-radius: var(--radius);
      overflow: hidden;
      flex: 1;
      min-width: 320px;
      max-width: 600px;
    }

    .curl-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 14px;
      background: #222240;
    }

    .curl-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #8888a8;
      font-family: 'JetBrains Mono', monospace;
    }

    .curl-copy {
      background: none;
      border: 1px solid rgba(255,255,255,0.12);
      color: #aaa;
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      transition: all 0.15s;
    }

    .curl-copy:hover {
      border-color: rgba(255,255,255,0.3);
      color: white;
    }

    .curl-copy.copied {
      border-color: var(--green);
      color: #00e676;
    }

    .curl-code {
      padding: 14px 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.8;
      color: #e4e4ef;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .curl-code .curl-flag { color: #ff9100; }
    .curl-code .curl-str { color: #a78bfa; }

    .curl-step-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--orange);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .curl-toggle {
      padding: 8px 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .curl-toggle:hover {
      border-color: var(--text-secondary);
      color: var(--text);
    }

    .curl-toggle.active {
      background: #1a1a2e;
      color: #e4e4ef;
      border-color: #1a1a2e;
    }

    .curl-toggle .arrow {
      transition: transform 0.2s;
      font-size: 10px;
    }

    .curl-toggle.active .arrow {
      transform: rotate(180deg);
    }

    /* â”€â”€â”€ Main grid area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1;
      padding: 24px 32px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 14px;
      flex: 1;
      align-content: start;
      overflow: hidden;
    }

    /* â”€â”€â”€ Player Cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 22px 18px 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }

    .cell:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .cell.completed {
      background: var(--green-bg);
      border-color: var(--green-border);
      box-shadow: 0 4px 16px rgba(0, 138, 5, 0.1);
    }

    .cell.in-progress {
      background: var(--orange-bg);
      border-color: #f0d9a8;
    }

    .cell-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 10px;
      background: var(--bg-warm);
      color: var(--text);
      text-transform: uppercase;
      transition: all 0.3s;
    }

    .cell.completed .cell-avatar {
      background: var(--green);
      color: white;
      animation: pop 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cell.in-progress .cell-avatar {
      background: var(--orange);
      color: white;
    }

    .cell-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      color: var(--text);
    }

    .cell-status {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-secondary);
    }

    .cell.completed .cell-status {
      color: var(--green);
      font-weight: 600;
    }

    .cell-checkmark {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: var(--green);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 900;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cell.completed .cell-checkmark {
      opacity: 1;
      transform: scale(1);
    }

    .cell-remove {
      position: absolute;
      top: 6px;
      left: 8px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-light);
      font-size: 13px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cell:hover .cell-remove { opacity: 0.5; }

    .cell-remove:hover {
      opacity: 1 !important;
      background: var(--primary-light);
      color: var(--primary);
    }

    .progress-bar {
      width: 100%;
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--orange), var(--green));
      border-radius: 2px;
      transition: width 0.3s;
    }

    .task-progress {
      display: flex;
      gap: 3px;
      margin-top: 8px;
    }

    .task-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.25s;
    }

    .task-dot.done { background: var(--green); }
    .task-dot.current { background: var(--primary); }

    /* â”€â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-secondary);
      gap: 14px;
    }

    .empty-state .icon { font-size: 48px; opacity: 0.2; }

    .empty-state p { font-size: 15px; font-weight: 500; }

    .empty-state code {
      background: var(--surface);
      padding: 10px 16px;
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      border: 1px solid var(--border);
    }

    /* â”€â”€â”€ Bottom bar (rounds) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bottom-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 32px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }

    .round-btn {
      width: 44px;
      height: 44px;
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      border-radius: 50%;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      position: relative;
    }

    .round-btn:hover {
      border-color: var(--text-secondary);
      color: var(--text);
      transform: scale(1.05);
    }

    .round-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 2px 12px rgba(255, 56, 92, 0.35);
      transform: scale(1.1);
    }

    .round-btn.all-done {
      background: var(--green);
      color: white;
      border-color: var(--green);
    }

    .round-btn.all-done.active {
      background: var(--green);
      border-color: var(--green);
      box-shadow: 0 2px 12px rgba(0, 138, 5, 0.35);
    }

    .round-connector {
      width: 24px;
      height: 2px;
      background: var(--border);
      border-radius: 1px;
    }

    .round-connector.done {
      background: var(--green);
    }

    /* â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }

    .modal-overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 32px;
      width: 400px;
      box-shadow: var(--shadow-xl);
      transform: scale(0.95) translateY(10px);
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-overlay.show .modal {
      transform: scale(1) translateY(0);
    }

    .modal h3 { font-size: 18px; font-weight: 700; margin-bottom: 20px; }

    .modal input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      outline: none;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }

    .modal input:focus {
      border-color: var(--text);
      box-shadow: 0 0 0 1px var(--text);
    }

    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

    .modal-btn {
      padding: 10px 22px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.15s;
    }

    .modal-btn.cancel { background: transparent; color: var(--text-secondary); }
    .modal-btn.cancel:hover { background: var(--bg-warm); }
    .modal-btn.confirm { background: var(--primary); color: white; border-color: var(--primary); }
    .modal-btn.confirm:hover { background: var(--primary-dark); }

    .modal-result {
      margin-top: 16px;
      padding: 12px 14px;
      background: var(--green-bg);
      border: 1px solid var(--green-border);
      border-radius: var(--radius);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--green);
      display: none;
      word-break: break-all;
    }

    /* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .cell { animation: slideUp 0.3s ease; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="top-left">
        <div class="logo">
          <span class="logo-icon">âš¡</span> N8N Arena
        </div>
        <div class="divider"></div>
        <div class="task-badge" id="taskBadge"></div>
      </div>
      <div class="top-right">
        <div class="stat-chip" id="statChip"></div>
        <button class="curl-toggle" id="curlToggle" onclick="toggleCurl()">
          <span>curl</span>
          <span class="arrow">â–¼</span>
        </button>
        <button class="top-btn add" onclick="showAddPlayer()">+ Player</button>
        <button class="top-btn danger" onclick="resetAll()">Reset</button>
      </div>
    </div>

    <!-- CURL DRAWER -->
    <div class="curl-drawer" id="curlDrawer">
      <div class="curl-inner" id="curlInner"></div>
    </div>

    <!-- MAIN GRID -->
    <div class="main">
      <div class="grid" id="grid"></div>
    </div>

    <!-- BOTTOM BAR (ROUNDS) -->
    <div class="bottom-bar" id="bottomBar"></div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h3>Add a new player</h3>
      <input type="text" id="playerNameInput" placeholder="Enter player name..." autocomplete="off" />
      <div class="modal-result" id="modalResult"></div>
      <div class="modal-actions">
        <button class="modal-btn cancel" onclick="hideModal()">Cancel</button>
        <button class="modal-btn confirm" onclick="registerPlayer()">Register</button>
      </div>
    </div>
  </div>

  <script>
    const BASE = window.location.origin;
    let state = { currentTask: 1, participants: [], taskDescriptions: [] };
    let previousCompleted = {};
    let curlOpen = false;

    // â”€â”€â”€ Real-time: SSE with polling fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function processState(newState) {
      state = newState;
      render();
      newState.participants.forEach((p) => {
        const prev = previousCompleted[p.id] || [];
        const newTasks = p.completedTasks.filter((t) => !prev.includes(t));
        if (newTasks.includes(newState.currentTask)) celebratePlayer(p.id);
        previousCompleted[p.id] = [...p.completedTasks];
      });
    }

    function connectSSE() {
      const es = new EventSource(`${BASE}/api/events`);
      es.onmessage = (e) => processState(JSON.parse(e.data));
      es.onerror = () => { es.close(); startPolling(); };
    }

    let pollTimer = null;
    async function poll() {
      try {
        const res = await fetch(`${BASE}/api/state`);
        processState(await res.json());
      } catch (e) {}
    }
    function startPolling() {
      if (pollTimer) return;
      poll();
      pollTimer = setInterval(poll, 1000);
    }

    connectSSE();

    // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      renderTopBar();
      renderCurl();
      renderGrid();
      renderBottomBar();
    }

    function renderTopBar() {
      const task = state.taskDescriptions.find((t) => t.id === state.currentTask);
      if (!task) return;

      const completed = state.participants.filter((p) => p.completedTasks.includes(state.currentTask)).length;
      const total = state.participants.length;
      const pct = total ? Math.round((completed / total) * 100) : 0;

      document.getElementById('taskBadge').innerHTML = `
        <span class="round-pill">Round ${task.id}</span>
        <span class="task-title">${task.icon} ${task.title}</span>
        <span class="task-desc">â€” ${task.subtitle}</span>
      `;

      document.getElementById('statChip').innerHTML = `
        <span class="stat-num">${completed}/${total}</span>
        <div class="stat-bar-mini"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
      `;
    }

    // â”€â”€â”€ CURL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleCurl() {
      curlOpen = !curlOpen;
      document.getElementById('curlDrawer').classList.toggle('open', curlOpen);
      document.getElementById('curlToggle').classList.toggle('active', curlOpen);
    }

    function getCurlCommands(taskId) {
      const url = BASE;
      const id = '{your-id}';
      switch (taskId) {
        case 1:
          return [{ label: null, cmd: `curl ${url}/api/player/${id}/task1`, raw: `curl ${url}/api/player/${id}/task1` }];
        case 2:
          return [{ label: null,
            cmd: `curl <span class="curl-flag">-u</span> <span class="curl-str">n8n:rocks</span> ${url}/api/player/${id}/task2`,
            raw: `curl -u n8n:rocks ${url}/api/player/${id}/task2` }];
        case 3:
          return [{ label: null,
            cmd: `curl <span class="curl-flag">-u</span> <span class="curl-str">n8n:rocks</span> <span class="curl-flag">-X POST</span> \\\n  <span class="curl-flag">-H</span> <span class="curl-str">"Content-Type: application/json"</span> \\\n  <span class="curl-flag">-d</span> <span class="curl-str">'{"message": "Hello from N8N!"}'</span> \\\n  ${url}/api/player/${id}/task3`,
            raw: `curl -u n8n:rocks -X POST -H "Content-Type: application/json" -d '{"message": "Hello from N8N!"}' ${url}/api/player/${id}/task3` }];
        case 4:
          return [{ label: 'Run this 4 times!',
            cmd: `curl <span class="curl-flag">-X POST</span> ${url}/api/player/${id}/task4`,
            raw: `curl -X POST ${url}/api/player/${id}/task4` }];
        case 5:
          return [
            { label: 'Step 1 â€” Get the key', cmd: `curl ${url}/api/player/${id}/task5/key`, raw: `curl ${url}/api/player/${id}/task5/key` },
            { label: 'Step 2 â€” Post it back',
              cmd: `curl <span class="curl-flag">-X POST</span> \\\n  <span class="curl-flag">-H</span> <span class="curl-str">"Content-Type: application/json"</span> \\\n  <span class="curl-flag">-d</span> <span class="curl-str">'{"key": "PASTE_KEY_HERE"}'</span> \\\n  ${url}/api/player/${id}/task5`,
              raw: `curl -X POST -H "Content-Type: application/json" -d '{"key": "PASTE_KEY_HERE"}' ${url}/api/player/${id}/task5` }
          ];
        case 6:
          return [{ label: null,
            cmd: `curl <span class="curl-flag">-X POST</span> \\\n  <span class="curl-flag">-H</span> <span class="curl-str">"Content-Type: application/json"</span> \\\n  <span class="curl-flag">-d</span> <span class="curl-str">'{"image": "data:image/png;base64,iVBOR..."}'</span> \\\n  ${url}/api/player/${id}/task6`,
            raw: `curl -X POST -H "Content-Type: application/json" -d '{"image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="}' ${url}/api/player/${id}/task6` }];
        default: return [];
      }
    }

    function copyCurl(btn, text) {
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = 'âœ“ Copied';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
      });
    }

    function renderCurl() {
      const task = state.taskDescriptions.find((t) => t.id === state.currentTask);
      if (!task) return;
      const curls = getCurlCommands(task.id);
      document.getElementById('curlInner').innerHTML = curls.map((c) => `
        <div style="flex:1;min-width:300px;max-width:600px;">
          ${c.label ? `<div class="curl-step-label">${c.label}</div>` : ''}
          <div class="curl-block">
            <div class="curl-header">
              <span class="curl-label">curl</span>
              <button class="curl-copy" onclick="copyCurl(this, ${JSON.stringify(c.raw).replace(/"/g, '&quot;')})">Copy</button>
            </div>
            <div class="curl-code">${c.cmd}</div>
          </div>
        </div>
      `).join('');
    }

    // â”€â”€â”€ Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderGrid() {
      const grid = document.getElementById('grid');

      if (state.participants.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="icon">ðŸ‘¥</div>
            <p>No players yet</p>
            <code>POST ${BASE}/api/register { "name": "..." }</code>
          </div>`;
        return;
      }

      grid.innerHTML = state.participants.map((p) => {
        const done = p.completedTasks.includes(state.currentTask);
        const inProgress = state.currentTask === 4 && p.postCount > 0 && !done;
        let cls = 'cell';
        if (done) cls += ' completed';
        else if (inProgress) cls += ' in-progress';

        const initials = p.name.split(' ').map((w) => w[0]).join('').slice(0, 2);

        let statusText = 'Waiting...';
        if (done) statusText = 'âœ“ Completed';
        if (state.currentTask === 4 && !done) statusText = `${p.postCount}/4 requests`;

        const progressBar = state.currentTask === 4 && !done
          ? `<div class="progress-bar"><div class="progress-fill" style="width:${(p.postCount/4)*100}%"></div></div>` : '';

        const dots = state.taskDescriptions.map((t) =>
          `<div class="task-dot ${p.completedTasks.includes(t.id) ? 'done' : ''} ${t.id === state.currentTask ? 'current' : ''}"></div>`
        ).join('');

        return `
          <div class="cell ${cls}" id="cell-${p.id}">
            <button class="cell-remove" onclick="removePlayer('${p.id}')" title="Remove">Ã—</button>
            <div class="cell-checkmark">âœ“</div>
            <div class="cell-avatar">${initials}</div>
            <div class="cell-name" title="${p.name}">${p.name}</div>
            <div class="cell-status">${statusText}</div>
            ${progressBar}
            <div class="task-progress">${dots}</div>
          </div>`;
      }).join('');
    }

    // â”€â”€â”€ Bottom bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderBottomBar() {
      const bar = document.getElementById('bottomBar');
      bar.innerHTML = state.taskDescriptions.map((t, i) => {
        const allDone = state.participants.length > 0 && state.participants.every((p) => p.completedTasks.includes(t.id));
        let cls = 'round-btn';
        if (t.id === state.currentTask) cls += ' active';
        if (allDone) cls += ' all-done';

        const connector = i < state.taskDescriptions.length - 1
          ? `<div class="round-connector ${allDone ? 'done' : ''}"></div>` : '';

        return `<button class="${cls}" onclick="setTask(${t.id})">${t.id}</button>${connector}`;
      }).join('');
    }

    // â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function setTask(task) {
      await fetch(`${BASE}/api/admin/task`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ task }) });
    }

    async function resetAll() {
      if (!confirm('Reset all progress?')) return;
      await fetch(`${BASE}/api/admin/reset`, { method: 'POST' });
    }

    async function removePlayer(id) {
      if (!confirm('Remove this player?')) return;
      await fetch(`${BASE}/api/admin/player/${id}`, { method: 'DELETE' });
    }

    // â”€â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAddPlayer() {
      document.getElementById('modal').classList.add('show');
      document.getElementById('playerNameInput').value = '';
      document.getElementById('modalResult').style.display = 'none';
      setTimeout(() => document.getElementById('playerNameInput').focus(), 100);
    }

    function hideModal() { document.getElementById('modal').classList.remove('show'); }

    async function registerPlayer() {
      const name = document.getElementById('playerNameInput').value.trim();
      if (!name) return;
      const res = await fetch(`${BASE}/api/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
      const data = await res.json();
      const result = document.getElementById('modalResult');
      result.style.display = 'block';
      result.textContent = `âœ“ Registered! ID: ${data.id}`;
      document.getElementById('playerNameInput').value = '';
      document.getElementById('playerNameInput').focus();
    }

    document.getElementById('playerNameInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') registerPlayer();
      if (e.key === 'Escape') hideModal();
    });

    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) hideModal();
    });

    // â”€â”€â”€ Celebration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function celebratePlayer(id) {
      const cell = document.getElementById(`cell-${id}`);
      if (!cell) return;
      for (let i = 0; i < 16; i++) {
        const particle = document.createElement('div');
        const colors = ['#FF385C', '#008A05', '#c77800', '#6c5ce7', '#00b0ff', '#ffea00'];
        const size = 4 + Math.random() * 5;
        particle.style.cssText = `position:fixed;width:${size}px;height:${size}px;border-radius:${Math.random()>0.5?'50%':'2px'};background:${colors[Math.floor(Math.random()*colors.length)]};pointer-events:none;z-index:999;`;
        const rect = cell.getBoundingClientRect();
        particle.style.left = (rect.left + rect.width / 2) + 'px';
        particle.style.top = (rect.top + rect.height / 2) + 'px';
        document.body.appendChild(particle);
        const angle = (Math.PI * 2 * i) / 16;
        const dist = 50 + Math.random() * 70;
        particle.animate([
          { transform: 'translate(0,0) scale(1)', opacity: 1 },
          { transform: `translate(${Math.cos(angle)*dist}px,${Math.sin(angle)*dist-20}px) scale(0)`, opacity: 0 }
        ], { duration: 700, easing: 'cubic-bezier(0.4,0,0.2,1)' }).onfinish = () => particle.remove();
      }
    }
  </script>
</body>
</html>
